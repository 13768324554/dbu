#!/bin/bash
#Description: First-run desktop user setup/customization script
#https://github.com/nodiscc/dbu

#TODO remove sudo group by default from /etc/adduser.conf
#TODO setup samba shares
#TODO set noatime/nodiratime for ext3/4 partitions?

###########################################

function _dbuCheckInetAccess() {
    netaccess=$(LANG=C nmcli networking connectivity)
    if [ "$netaccess" != "full" ]
        then
        _dbuSetupInetAccess
    fi
}

function _dbuSetupInetAccess() {
    zenity --no-wrap --question --ok-label "Retry" --cancel-label "Stay offline" \
    --title "Network connection" --text \
"It appears this computer is curently not connected
to the Internet. An Internet connection is required to
update software to latest versions. Please connect to
a network using the network manager menu in panel, then
clock retry. If you choose to continue without a network
connection, software updates will be unavailable."
    if [ $? = 0 ]
        then _dbuCheckInetAccess
    fi
}

function _dbuRemoveAutostartEntry() {
    rm ~/.config/autostart/dbu-setup.desktop
}

############################################

function _dbuSetupDialog {
    answer=$(zenity --width 120 --height 330 --list --checklist --hide-header --column=C1 --column=C2 \
    FALSE "Setup appearance" \
    FALSE "Setup panel" \
    FALSE "Setup desktop" \
    TRUE "Setup virtual workspaces" \
    TRUE "Setup power management" \
    TRUE "Setup time and date"
    TRUE "Setup instant messaging accounts" \
    TRUE "Setup e-mail accounts" \
    TRUE "Setup RSS news feeds" \
    TRUE "Setup printers" \
    TRUE "Setup desktop session/autostart" \
    TRUE "Setup system services" \
    TRUE "Setup user accounts and passwords" \
    TRUE "Upgrade all packages" \
    TRUE "Manage installed software" \
    )

    IFS=$'|'
    for action in $answer; do 
        case "$action" in 
            "Setup appearance") xfce4-appearance-settings; xfwm4-settings
            ;;
            "Setup panel") xfce4-panel -p
            ;;
            "Setup desktop") xfdesktop-settings
            ;;
            "Setup virtual workspaces") xfwm4-workspace-settings
            ;;
            "Setup power management") xfce4-power-manager-settings
            ;;
            "Setup time and date") time-admin
            ;;
            "Setup instant messaging accounts") pidgin &
            ;;
            "Setup e-mail accounts") icedove
            ;;
            "Setup RSS news feeds") liferea & 
            ;;
            "Setup printers") system-config-printer
            ;;
            "Setup desktop session/autostart") xfce4-session-settings
            ;;
            "Setup system services") services-admin
            ;;
            "Setup user accounts and passwords") users-admin
            ;;
            "Upgrade all packages") gpk-update-viewer
            ;;
            "Manage installed software") gpk-application
            ;;
        esac
    done
    unset IFS
}

_dbuCheckInetAccess
_dbuSetupDialog
_dbuRemoveAutostartEntry
